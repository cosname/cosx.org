---
title: R Markdown 制作 beamer 幻灯片
author: 黄湘云
date: '2022-07-04'
meta_extra: "审稿：楚新元"
slug: beamer-down
categories:
  - R 语言
tags:
  - TinyTeX
  - LaTeX
  - beamer
  - R Markdown
output:
  blogdown::html_page:
    toc: true
    number_sections: true
bibliography: 
  - refer.bib
link-citations: true
csl: institute-of-mathematical-statistics.csl
thumbnail: https://user-images.githubusercontent.com/12031874/116777926-a1722100-aaa1-11eb-92c7-034ebfb90922.png
description: "LaTeX 提供 beamer 文类主要用于学术报告，从面上来看，好多主题是大学开发的，大家不约而同地使用蓝调，看多了想睡觉。目前，现代风格的 beamer 主题已经陆续涌现出来，本文旨在介绍一条 R Markdown 制作 beamer 幻灯片的入坑路径，让 beamer 看起来更加清爽些！"
---



```{css}
#| echo: false

.rmdinfo {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.rmdinfo, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.todo {
  display: block;
  border: 1px solid #4285f4;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 0.5em 1em;
  margin: 1em 0;
}

.todo::before {
  content: "TO DO: ";
  font-weight: bold;
  color: #4285f4;
}

blockquote > p:last-child {
  text-align: right;
}
blockquote > p:first-child {
  text-align: inherit;
}

div.figure {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}
```
```{css}
#| echo: false

/* https://github.com/rstudio/bookdown/blob/main/inst/templates/default.html#L89-L113 */
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left: 2em;
  text-indent: -2em;
}
div.csl-left-margin {
  min-width: 2em;
  float: left;
}
div.csl-right-inline {
  margin-left: 1em;
  padding-left: 1em;
}
div.csl-indent {
  margin-left: 1em;
}
```

```{r}
#| label: setup
#| echo: false

# 控制输出的宽度
options(width = 69)
```


::: rmdinfo
声明：本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。
:::


- 2022-07-31 完成基础篇
- 2022-08-01 完成高级篇
- 2022-08-02 完成忍者篇
- 2022-08-03 完成技巧与陷阱
- 2022-08-04 论坛发布，并投稿
- 2022-08-05 修改、交付

尝试 8月1日 完稿

# 本文概览 {#overview}

R Markdown 站在 Markdown、Pandoc 和 R 等诸多巨人的肩膀上，支持动态文档写作，文本、代码相互交织，插图、表格、文献、引用等动态生成。在网站简历、期刊书籍、报告演示等诸多方面有大量应用。其中，报告演示（Presentations）是传递、交流想法的重要方式，R Markdown 生态有很多扩展包，提供多种方式制作幻灯片，支持的幻灯片种类有 Office PowerPoint（俗称 PPT）、ioslides、 [**reveal.js**](https://github.com/rstudio/revealjs) 和[写轮眼](https://github.com/yihui/xaringan)等。

本文将介绍如何用 R Markdown 制作 beamer 风格的幻灯片，包含以下内容：

(@background) 作者与 beamer 结缘和本文写作的始末。
(@setup) 准备本文涉及到的一些软件依赖和扩展包。
(@latex-beamer) 简单回顾一下 LaTeX 是如何制作 beamer 幻灯片的。
(@markdown-beamer) 作为后续铺垫，介绍 Pandoc's Markdown 制作 beamer 幻灯片的过程。
(@rmarkdown-beamer) 在 (@markdown-beamer) 的基础上，介绍 R Markdown 制作 beamer 幻灯片的过程，谓之「基础篇」。
(@rmarkdown-beamer-advanced) 在 (@rmarkdown-beamer) 的基础上，介绍 R Markdown 深度定制 beamer 幻灯片的过程，谓之「高级篇」。
(@rmarkdown-beamer-ninja) 在(@rmarkdown-beamer-advanced)的基础上，结合 LaTeX 和 Lua 两大神器，深度定制 beamer 幻灯片，谓之「忍者篇」。
(@beamer-tricks-pitfalls) 介绍 R Markdown 制作 beamer 幻灯片积累的技巧和陷阱。
(@beamer-final) 总结一下本文内容，写一点个人使用经验，仅供参考。

对于初学者，建议阅读(@background)、 (@setup) 、 (@latex-beamer) 和 (@rmarkdown-beamer)；对于入门者，建议继续阅读 (@markdown-beamer)、(@rmarkdown-beamer-advanced)、 (@beamer-tricks-pitfalls) 和 (@beamer-final)；对于进阶者，建议继续阅读 (@rmarkdown-beamer-ninja)。



<!-- 先基于 R Markdown 介绍制作普通 beamer 幻灯片的过程，然后介绍设置幻灯片主题、中英字体和数学公式，完整迁移到新的主题可能会遇到的问题。 -->


# 本文背景 {#background}

故事还要从头开始讲起，7-8 年前，出于学术答辩和课程汇报需要，陆续学习和使用 LaTeX 来排版作业和论文，曾有一段时间深陷此坑不能自拔，以至于遍览 [TeXLive](https://tug.org/texlive/) 内置的幻灯片制作宏包，收集了大量 beamer 幻灯片的模版，藏于 Github 仓库 [awesome-beamers](https://github.com/XiangyunHuang/awesome-beamers)。

LaTeX 在国外是比较流行的学术写作工具，在国内部分学校的数学或统计系会用它来排版毕业论文，相关的学习材料有很多，推荐 CTeX 开发小组翻译的[一份（不太）简短的LaTeX介绍](https://github.com/CTeX-org/lshort-zh-cn)。吴康隆的 [《简单粗暴LaTeX》](https://github.com/wklchris/Note-by-LaTeX)，盛文博翻译的[《LaTeX2e 插图指南, 第三版》](https://github.com/WenboSheng/epslatex-cn)，吕荐瑞的[科技文档排版课程材料](https://lvjr.bitbucket.io/tutorial/learn-latex.pdf)，曾祥东的[现代 LaTeX 入门讲座](https://github.com/stone-zeng/latex-talk)，都非常适合从零开始学习的。进阶的部分，根据需要去看宏包手册，LaTeX 宏包文档的长度一般都吓死个人，[PGF](https://github.com/pgf-tikz/pgf) 绘图 **1300** 多页，[pgfplots](https://ctan.org/pkg/pgfplots) 3D 绘图 **573** 页， [beamer](https://github.com/josephwright/beamer) 幻灯片制作 **247** 页，[geometry](https://github.com/davidcarlisle/geometry) 版面设置 **42** 页，[tcolorbox](https://github.com/T-F-S/tcolorbox) 箱子定制 **539**页，通常不需要从头到尾的看，除非遇到难处或需要自定义了。在对基础的 LaTeX 排版工具有一些了解后，日常使用过程中必备数学公式[速记小抄](https://gitlab.com/jim.hefferon/undergradmath) ，搭好梯子随时放狗去搜。

2020 年 6 月份搬迁完[汉风主题](https://github.com/liantze/pgfornament-han)，在论坛开帖分享了[成果](https://d.cosx.org/d/421591)，又被撺掇着在主站[立了字句](https://github.com/cosname/cosx.org/issues/901)----要写一篇文章介绍 R Markdown 制作幻灯片模版的过程，一直囿于工作繁忙，难以抽身，去年在 WX 上和[楚新元](https://gitlab.com/chuxinyuan)又聊到模版，看到有人又要准备趟我之前踩过的坑，心中不忍，咬咬牙还是把这文债给还了。算起来，从起心动念到最终交付拖延了两年而已！


# 软件配置 {#setup}

安装一些 R 包，一个轻量级 LaTeX 发行版 [TinyTeX](https://github.com/yihui/tinytex-releases)， LaTeX 幻灯片主题 [metropolis](https://github.com/matze/mtheme) 和 [beamer-verona](https://ctan.org/pkg/beamer-verona)，一些字体。


## 安装 R 包 {#setup-rpkgs}

默认大家已经安装了 R 软件和 RStudio IDE，这会让后面的操作变得更容易。
因陆续会用到 R Markdown 生态的几个 R 包，所以先提前安装下：

```{r}
#| eval: false
install.packages(c("tinytex", "knitr", "rmarkdown", "bookdown", "rticles"))
```

其中， R 包 **tinytex** [@tinytex2019] 用来安装轻量级的 LaTeX 发行版 TinyTeX，它是在构建在 LaTeX 宏包管理器 [tlmgr](https://tug.org/texlive/tlmgr.html) 之上，默认去掉了 LaTeX 宏包源码和帮助文档，做到 200M～300M 的大小。 **knitr** 包自不必多说，只要使用 R Markdown 文档就离不开它，本文大部分内容可以被 **rmarkdown** 的功能覆盖，**bookdown** 仅提供交叉引用的作用，**rticles** 包提供很多期刊杂志的投稿模版。




## 安装 TinyTeX {#setup-tinytex}

平时要是常用 R Markdown 相关扩展包，R 包 [**tinytex**](https://github.com/yihui/tinytex) 已经被安装上了，下面用它安装 TinyTeX 这个发行版，在 R 环境里，这一切会比较顺畅，讲真，配置环境什么的最烦了，一次两次三四次，五次六次七八次，但是学什么的时候最好从配置环境开始，记录从第一次安装开始，后面会越来越快！

```{r}
#| eval: false
tinytex::install_tinytex()
```

遇到啥问题，先去益辉的网站瞅瞅 <https://yihui.org/tinytex/>，要还没找到解决方案，就来论坛 <https://d.cosx.org/> 发帖。

## 安装字体 {#setup-fonts}

为了后续介绍 metropolis 主题，先安装和配置其所需字体，此过程分两步走：

1. 这里用 **tinytex** 包安装 [**fira**](https://www.ctan.org/pkg/fira) 系列英文字体，[**firamath**](https://github.com/firamath/firamath) 和 [**xits**](https://www.ctan.org/pkg/xits) 数学字体，后续用作 beamer 幻灯片的主要字体，相信大家看惯了千篇一律的字体，也想换换口味吧！

    ```{r}
    #| eval: false
    # 顺道把 beamertheme-metropolis 宏包也安装下
    tinytex::tlmgr_install(c("beamertheme-metropolis", "fira", "firamath", "firamath-otf", "xits"))
    ```

2. 通过「人工智能」查找，发现上面安装的字体都放在了 TinyTeX 的安装目录下，而且不能直接被调用，故而将它们拷贝到用户指定的字体目录，刷新字体目录后，通过 **fontspec** 宏包调用。为了加快复现的速度，我已经将这个复制粘贴的过程化作几行代码，如下：

    ```{r}
    #| eval: false
    
    # TinyTeX 字体目录
    basedir <- paste(tinytex::tinytex_root(), "texmf-dist/fonts/opentype/public", sep = "/")
    # MacOS 系统字体放在 ~/Library/Fonts/ 而 Linux 系统字体放在 ~/.fonts
    distdir <- if (xfun::is_macos()) "~/Library/Fonts/" else "~/.fonts"
    # 如果目录不存在就创建一个
    xfun::dir_create(distdir)
    # 字体文件的目录
    fontdir <- paste(basedir, c("fira", "xits", "firamath"), sep = "/")
    # 字体文件的路径
    fontfile <- list.files(path = fontdir, full.names = T)
    # 拷贝到字体目录下
    file.copy(from = fontfile, to = distdir, overwrite = TRUE)
    ```



# 制作 beamer 幻灯片

## LaTeX {#latex}

下面以 metropolis 主题为例介绍一个完整的 beamer 幻灯片。不记得初次见 metropolis 主题是什么时候，不过每次见都让我想到了 MCMC（**M**arkov **C**hain **M**onte **C**arlo，马尔科夫链蒙特卡洛，简称 MCMC）。学过 MCMC 算法的都知道 metropolis 是啥，我这半桶水的统计科班生就不在这献丑了，当年掉在 MCMC 的大坑里好多时间，以至于将 metropolis 和 MCMC 建立了极强的关联，可能这是我介绍 beamer 主题也拿它来举例的原因吧！

回到正题，Pandoc 内建的 LaTeX 模版功能已经很丰富了，通常用不着自己配置了，R Markdown 自从接入 **tinytex** 自动装缺失的 LaTeX 宏包的功能后，在产出 PDF 文档方面已经方便多了。

metropolis 主题的特点就是干净利索，简洁优雅！顺便一提，在之前的文章[可重复性数据分析](https://xiangyun.rbind.io/2021/01/reproducible-analysis/)介绍过[林莲枝](https://github.com/liantze/)开发的汉风主题幻灯片，它是 metropolis 主题的衍生品。算上空行，只有十几行代码。


```{verbatim, file="examples/slide-template.tex", lang="tex"}
```

注意看加载 **unicode-math** 宏包时的选项设置，关于 **unicode-math** 数学符号的样式（比如选择 ISO 还是 TeX？） 说明见[文档](https://www.latex-project.org/publications/2010-wspr-TUG-unicode-mathematics-in-LaTeX-slides.pdf)，对绝大多数的使用者来说，做个拿来主义就好，别看我洋洋洒洒写了这么多，我也不例外，喜欢哪个用哪个！


将上面的模版内容保存到文件 `slide-template.tex`，接下来，有两种编译 LaTeX 文件的方式，一种在 [RStudio IDE](https://github.com/rstudio/rstudio) 内打开，点击 **Compile PDF** 按钮，另一种是在 R 控制台里执行

```r
tinytex::xelatex(file = "slide-template.tex")
```

编译出来的效果如下：

![(\#fig:latex-metropolis)metropolis 幻灯片主题](https://user-images.githubusercontent.com/12031874/116777926-a1722100-aaa1-11eb-92c7-034ebfb90922.png)


用 Adobe Acrobat Reader DC 打开 `文件->属性->字体` 可以看到 PDF 文档中确切使用的字体，如下图所示。

![检查文档实际使用的字体](https://user-images.githubusercontent.com/12031874/135288310-4dad120c-a883-4732-9033-72be7b8ffe28.png)



::: rmdnote
在 Windows 系统上，需要选中字体右键安装并刷新字体缓存或者像下面这样指定字体路径。

```tex
% 假定字体存放在目录 ~/.fonts/
% 设置字体需要如下代码
\setsansfont[Path = {\string~/.fonts/}, BoldFont={Fira Sans SemiBold}]{Fira Sans Book}
\setmathfont[Path = {\string~/.fonts/}]{Fira Math}
\setmathfont[Path = {\string~/.fonts/}, range={\top}]{XITS Math}
```
:::



## Pandoc's Markdown {#pandoc-markdown}

R Markdown 背后是非常依赖 Pandoc 的，RStudio IDE 已经捆绑了 [Pandoc 软件](https://pandoc.org/)，一般不需要用户再去下载，安装完 RStudio IDE 就可以直接用它了。

### 简单示例

继续上面的例子，将幻灯片的内容用 Markdown 格式书写，非常简洁了，算上空行仅有 6 行代码，如下：


```md
## Example

\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
```

将内容保存为 `slide-template.md` 文件，接着，在命令行窗口中执行命令：

```bash
pandoc --pdf-engine xelatex -t beamer \
  slide-template.md -o slide-template.pdf
```

即可编译出 PDF 格式的 beamer 幻灯片，效果如下：

![(\#fig:md-default)Pandoc 转 Markdown 文档为 PDF 格式的幻灯片文档](https://user-images.githubusercontent.com/12031874/182017315-378a0472-c99b-4499-8d13-a5f409961cb0.png)

::: rmdtip
上面用到的 Pandoc 的命令行参数：

- `--pdf-engine` 指定文档编译引擎，因输出是 beamer 文档，需要选择一个 LaTeX 编译引擎，常用的有 `pdflatex` / `xelatex` / `lualatex`。
- `-t FORMAT` 指定输出文件的格式，等价于 `--to=FORMAT`，这里输出 beamer 文档。
- `-o FILE` 指定输出文件位置，等价于 `--output=FILE`，这里和输入文档 `slide-template.md` 一起输出 `slide-template.pdf`。

更多详情见文档[Pandoc 通用选项](https://pandoc.org/MANUAL.html#general-options)。
:::


### LaTeX 模版

风格明显和之前的图\@ref(fig:latex-metropolis)不同，因为没有设置 beamer 幻灯片主题和字体，Pandoc 将调用内置的 LaTeX 模版。可以执行如下命令获取 Pandoc 内置的 LaTeX 模版 `custom-reference.tex`。

```bash
pandoc -o custom-reference.tex --print-default-template latex
```

Pandoc 内置的 LaTeX 模版内容非常多，因为它是大一统的，支持书籍、报告、演示等等使用场景。通过传递模版变量，可以控制文档类型及其选项，如布局、字体等。下面是模版开头的几行内容：

```latex
% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode$for(hyperrefoptions)$,$hyperrefoptions$$endfor$}{hyperref}
\PassOptionsToPackage{hyphens}{url}
$if(colorlinks)$
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
$endif$
```

`hyperrefoptions` 和 `colorlinks` 就是两个变量，它们被一对美元符号前后包围。遇到 `if` 意味着可以传递布尔值 `true` / `false`，遇到 `for` 意味着可以传递一个数组，LaTeX 宏包 hyperref 参数选项非常多， 查看[其帮助文档](http://mirrors.ctan.org/macros/latex/contrib/hyperref/doc/hyperref-doc.pdf)，可以知道能够传递的值有哪些。下面是一个例子：

```
hyperrefoptions:
  - linktoc=all        # 目录带跳转链接
  - bookmarksnumbered=true # 书签带编号
  - pdfstartview=FitH  # 适合页面宽度
```

hyperref 帮助文档 5.5 节介绍 linktoc 选项，5.6 节介绍 bookmarksnumbered 选项，5.7 节介绍 pdfstartview 选项，通过帮助文档，就知道宏包有哪些控制选项及其取值。


<details>
<summary> 点击查看 Pandoc 内置的 LaTeX 模版内容 </summary>

```{verbatim, file="examples/custom-reference.tex", lang="tex"}
```

</details>

### 英文字体

在现有的基础上，通过 Pandoc 命令行参数 `--variable` 继续传递 [模版变量](https://pandoc.org/MANUAL.html#general-writer-options)，如设置英文字体：

```bash
pandoc --pdf-engine xelatex -t beamer \
  --variable sansfont="Fira Sans Book" \
  --variable sansfontoptions="BoldFont={Fira Sans SemiBold}" \
  -f markdown slide-template.md \
  -o slide-template.pdf
```

![(\#fig:md-sansfont) 设置英文字体](https://user-images.githubusercontent.com/12031874/182020087-77c051d9-ca5d-4264-8208-3e707944a63a.png)

### 幻灯主题

或设置幻灯片主题：

```bash
pandoc --pdf-engine xelatex -t beamer \
  --variable theme="metropolis" \
  --variable fonttheme="professionalfonts" \
  -f markdown slide-template.md \
  -o slide-template.pdf
```

![(\#fig:md-theme)设置幻灯片主题](https://user-images.githubusercontent.com/12031874/182020012-da2f78d7-dfc7-4d47-9ed9-e326d4588a38.png)

### 数学字体

或设置数学字体：

```bash
pandoc --pdf-engine xelatex -t beamer \
  --variable mathfont="XITS Math" \
  -f markdown slide-template.md \
  -o slide-template.pdf
```

![(\#fig:md-mathfont)设置数学字体](https://user-images.githubusercontent.com/12031874/182020058-b9b7c05a-379f-49ec-8eef-3a84bbb45e90.png)

### 幻灯首页

除了支持传递模版变量控制文档类型和元素，还可以在 Markdown 文档中添加[文档元数据](https://pandoc.org/MANUAL.html#metadata-variables)，比如幻灯片标题、副标题、作者等等，它们是一组 YAML 格式的键值对。效果和通过 Pandoc 命令行参数 `--metadata` 传值类似。

```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
```

与之前类似，执行如下命令：

```bash
pandoc --pdf-engine xelatex -t beamer \
  slide-template.md -o slide-template.pdf
```

渲染出来的效果如下：

![(\#fig:md-meta)设置文档元数据](https://user-images.githubusercontent.com/12031874/182020544-1c5ecce9-9e6c-4c93-beff-369349939e63.gif)

### 双栏排版

还可在文档中添加双栏排版，下面添加了两个双栏，第一个将页面等分，第二个将页面三七开，效果如图\@ref(fig:md-meta-columns)。

```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

:::::::::::::: {.columns}
::: {.column width="50%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::: {.column width="50%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::::::::::::::

:::::::::::::: {.columns}
::: {.column width="30%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::: {.column width="70%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::::::::::::::
```


渲染出来的效果如下：

![(\#fig:md-meta-columns)设置文档双栏排版](https://user-images.githubusercontent.com/12031874/182062362-c1d0e6cd-b1de-4095-933d-2624266ba9a5.gif)

### 暂停显示

还可以暂停显示幻灯片内容，这好像将一页的内容，分成几页展示，中间加了暂停键。只要在两段内容之间插入带空格的三个点 `. . .`，渲染效果如图\@ref(fig:md-meta-pauses)。



```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

:::::::::::::: {.columns}
::: {.column width="50%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::: {.column width="50%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::::::::::::::

. . .

:::::::::::::: {.columns}
::: {.column width="30%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::: {.column width="70%"}
\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
:::
::::::::::::::
```


![(\#fig:md-meta-pauses)添加暂停键，分页展示内容](https://user-images.githubusercontent.com/12031874/182080840-ca01d7b1-ba84-4b6a-95f2-68ff494f832e.gif)

### 滚动显示

与上面分段显示内容类似，还可逐条展示列表内容，效果如图\@ref(fig:md-meta-incremental)。

```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

::: incremental

- Eat spaghetti
- Drink wine

:::
```

![(\#fig:md-meta-incremental)逐条展示列表条目](https://user-images.githubusercontent.com/12031874/182083227-2bd9084f-07b2-4eb3-8ddb-e01843dbdcd9.gif)


### 添加背景


在 Markdown 文档的 YAML 里设置 `background-image` 指定背景图片，将背景图片和Markdown 文档放一起或指定背景图片的存放路径。


```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
background-image: Rlogo.pdf
---

## Example

\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
```

渲染效果，如图\@ref(fig:md-meta-background)所示。

```bash
pandoc --pdf-engine xelatex -t beamer \
  slide-template.md -o slide-template.pdf
```

![(\#fig:md-meta-background)添加幻灯片背景](https://user-images.githubusercontent.com/12031874/182089094-a5b5fa8b-8527-4b82-bc1e-8e70cee98e87.gif)


### 插入表格

Markdown 是支持显示表格的，其语法不再赘述，下面是一个插入表格的示例，渲染效果如图所示。


```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

  Right     Left     Center     Default
-------     ------ ----------   -------
     12     12        12            12
    123     123       123          123
      1     1          1             1

Table:  Demonstration of simple table syntax.
```

![(\#fig:md-meta-table)插入表格](https://user-images.githubusercontent.com/12031874/182091134-8e29b6ed-318c-4115-a275-2e4ab4f6f0af.gif)

更多样式的表格见 Pandoc 帮助文档中[表格部分](https://pandoc.org/MANUAL.html#tables)的介绍。


### 插入图片

继续使用之前的 R 语言 Logo 图片，Pandoc's Markdown 扩展了原始 Markdown 的功能，插入图片的同时支持设置图片宽度，效果如图\@ref(fig:md-meta-figure)所示。

```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

![This is the caption](Rlogo.pdf){ width=35% }
```

![(\#fig:md-meta-figure)插入图片](https://user-images.githubusercontent.com/12031874/182092322-f4d70149-0615-4261-be47-6fa711d8df0f.gif)


更多功能见 Pandoc's Markdown 帮助文档中[插入图片](https://pandoc.org/MANUAL.html#images)一节。


### 独立页面

还可显示单独的一页，此页没有标题，常用于末尾 Q&A 和致谢环节，给该页幻灯片设置 standout 属性。


```md
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
---

## Example

\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}

## {.standout}

Q & A
```

因默认的幻灯片主题不支持设置 standout，下面采用 metropolis 主题，效果如图\@ref(fig:md-meta-standout)。

```bash
pandoc --pdf-engine xelatex -t beamer \
  --variable theme="metropolis" \
  --variable fonttheme="professionalfonts" \
  -f markdown slide-template.md \
  -o slide-template.pdf
```


![(\#fig:md-meta-standout)设置单独一页用于 Q&A 环节](https://user-images.githubusercontent.com/12031874/182086098-bdc5dfc6-e291-4397-a2a9-778af18720d2.gif)


### 更多功能

Pandoc 还支持很多功能，比如添加脚注、格言警句引用、图表和文献交叉引用、抄录代码块等等，众多功能有待读者去探索发现。

::: rmdtip
Pandoc 除了能将 Markdown 文档转化为 beamer 幻灯片，还可将其转化为 DOCX 格式的 Word 文档、PPTX 格式的 PowerPoint 文档等。除了前面介绍的 LaTeX 模版，Pandoc 还内建了 Word、PowerPoint 等诸多文档模版，获取其它文档格式的模版，稍有不同，比如 DOCX 文档。

```bash
pandoc -o custom-reference.docx --print-default-data-file reference.docx
```

更多详情见[Pandoc 用户手册](https://pandoc.org/MANUAL.html#options-affecting-specific-writers)。
:::


## R Markdown（基础篇）{#rmarkdown-basic}

首先 Pandoc's Markdown 支持的功能， R Markdown 都支持，相比于 Pandoc's Markdown，R Markdown 可以省去命令行操作，使用起来简便些。不过，需要适当学习一下 **knitr**、**rmarkdown** 和 **bookdown** 三个包。在 Rmd 文档中设置输出格式。R Markdown 文档开头处为 YAML 元数据，它分三部分：其一是文档元数据设置，其二是文档输出设置，其三是 Pandoc 变量值设置。

```
---
title:  'This is the title'
subtitle: "This is the subtitle"
author:
- Author One
- Author Two
institute: "Capital of Statistics"
output: 
  beamer_presentation: 
    latex_engine: xelatex
    theme: metropolis
    template: null
mathspec: true
---

## Example

\begin{align}
    \boldsymbol{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
```

`output` 行往下在设置文档类型及编译控制选项，完整的选项列表及其说明可从函数帮助文档 `?rmarkdown::beamer_presentation()` 处获得，下面是函数`beamer_presentation()`的参数列表，它包含三部分，其一属于 beamer 文档的控制选项（比如`theme` / `colortheme` / `fonttheme`等），其二属于 Pandoc 转化器的控制选项（比如`latex_engine`/`citation_package`/`self_contained`等），其三属于 R Markdown 独有的控制选项（比如 `fig_width` / `fig_height` / `dev` 等）。`mathspec: true` 传递给 Pandoc 内建的 LaTeX 模版，意味着不要使用宏包 unicode-math 处理数学公式，而使用 mathspec 处理。对照参数名和参数值，将上面文档中的输出选项与下面的函数参数列表对应起来。

```r
beamer_presentation(
  toc = FALSE,
  slide_level = NULL,
  number_sections = FALSE,
  incremental = FALSE,
  fig_width = 10,
  fig_height = 7,
  fig_crop = "auto",
  fig_caption = TRUE,
  dev = "pdf",
  df_print = "default",
  theme = "default",
  colortheme = "default",
  fonttheme = "default",
  highlight = "default",
  template = "default",
  keep_tex = FALSE,
  keep_md = FALSE,
  latex_engine = "pdflatex",
  citation_package = c("default", "natbib", "biblatex"),
  self_contained = TRUE,
  includes = NULL,
  md_extensions = NULL,
  pandoc_args = NULL
)
```

渲染出来的文档效果如下图。

![(\#fig:rmd-metropolis)R Markdown 示例](https://user-images.githubusercontent.com/12031874/182024613-97dcff19-8e9b-4428-98ff-dc9fa444d20e.gif)

下面拆解一下 R Markdown 编译出 beamer 幻灯片的过程，当用户点击 Knit 按钮，Render 窗口就会活动起来，knitr 包会根据文档中的代码块，调各类解释器、编译器执行文档中的代码，并返回结果，生成中间产物 Markdown 文件，再调用 Pandoc 转化器，将 Markdown 文档转为 LaTeX 代码，再调用 LaTeX 编译器（如 XeLaTeX）编译出目标文件，PDF 格式的 beamer 幻灯片，图\@ref(fig:rmd-metropolis-compile)左侧是示例文件，右侧是 Render 窗口的编译过程。注意看图\@ref(fig:rmd-metropolis-compile)右侧红框内的内容，是不是很熟悉的感觉，其实就是一个 Pandoc 转化命令。


![(\#fig:rmd-metropolis-compile)R Markdown 编译过程](https://user-images.githubusercontent.com/12031874/182069798-33d77872-8cca-4903-8de6-9e42f3ee11f5.png)

---

接下来，将上面的英文 R Markdown 文档汉化一下，

















下面是一份完整的**中文** R Markdown 模版，有了前面关于英文 R Markdown 文档的介绍，此时，想必已不再感到陌生。 ctexbeamer 和 ctexart 文类都来自 [ctex 宏包](https://ctan.org/pkg/ctex)，想汉化必须看看它的帮助文档。相比于上面的英文 R Markdown 文档，这里只添加两个 Pandoc 变量，一个设置中文 beamer 文类 `documentclass: ctexbeamer`，另一个在文类选项中设置中文字体 `classoption: "fontset=fandol"`，设置它们的效果类似在 LaTeX 文档中添加如下的一行代码。

```tex
\documentclass[fontset=fandol]{ctexbeamer}
```

读者若有兴趣，可以查阅 [ctex 宏包](https://ctan.org/pkg/ctex) 帮助文档，了解 ctexbeamer 文类的其它选项。

````
---
title: "R Markdown 制作 beamer 幻灯片"
author: "黄湘云"
date: "2021年10月01日"
institute: "统计之都"
documentclass: ctexbeamer
output: 
  beamer_presentation: 
    latex_engine: xelatex
    theme: metropolis
    template: null
classoption: "fontset=fandol"
---

## 示例

\begin{align}
    \symbf{\theta} &= (1, 2, 3)^\top \\
        \theta_0 &= 1
\end{align}
````

![(\#fig:rmd-metropolis-zh) 中文 R Markdown 示例](https://user-images.githubusercontent.com/12031874/182027292-0b24fb9b-7804-4ad5-940c-591ff1fd695d.gif)

在日常使用中，beamer 幻灯片常用于学术性报告，各种各样的公式符号随处可见。

````
---
title: "R Markdown 制作 beamer 幻灯片"
author: "黄湘云"
date: "2021年10月01日"
institute: "统计之都"
documentclass: ctexbeamer
output: 
  beamer_presentation: 
    latex_engine: xelatex
    theme: metropolis
    template: null
classoption: "fontset=fandol"
---

## 介绍

数学公式还是用 LaTeX 排版的好， 
$\symbf{\Sigma}$ 是希腊字母 $\Sigma$ 的加粗形式，
$\mathcal{A}$ 是普通字母 $A$ 的花体形式。
````

编译后的效果如下：

![(\#fig:rmd-metropolis-zh-math) 中文 R Markdown 示例里添加数学公式](https://user-images.githubusercontent.com/12031874/182028411-e21c0d18-f1b8-4834-b41a-7ba618c9a9e4.gif)


beamer 学术幻灯片的另一大特色是定理、推论满天飞。在现有的基础上，继续添加定理、引理等文本块，内容如下：


````
---
title: "R Markdown 制作 beamer 幻灯片"
author: "黄湘云"
date: "2021年10月01日"
institute: "统计之都"
documentclass: ctexbeamer
output: 
  beamer_presentation: 
    latex_engine: xelatex
    theme: metropolis
    template: null
classoption: "fontset=fandol"
---

## 介绍

数学公式还是用 LaTeX 排版的好， 
$\symbf{\Sigma}$ 是希腊字母 $\Sigma$ 的加粗形式，
$\mathcal{A}$ 是普通字母 $A$ 的花体形式。

::: {.theorem data-latex="[勾股定理]"}
这是定理内容
:::

::: {.lemma data-latex="[N-P 引理]"}
这是引理内容
:::
````


渲染效果如下：

![(\#fig:rmd-metropolis-zh-block) 中文 R Markdown 示例里添加定理、引理](https://user-images.githubusercontent.com/12031874/182034761-c7fee605-4729-487b-af20-e423ba7b2af0.gif)







至此，关于 R Markdown 制作 beamer 幻灯片的主题介绍可以告一段落了！

::: rmdnote
眼力犀利的读者可能已经看出上面模版中使用 **unicode-math** 处理数学公式，导致符号样式怪怪的，`\boldsymbol` 也无法加粗希腊字母，这里留个疑问，且看下回分解。
:::





## R Markdown（高级篇）{#rmarkdown-advanced}

本节介绍更多的内容：

1. 常用选项控制，
1. 双栏或多栏，
1. 条目滚动显示，
1. 图、表、文献的交叉引用，
1. 切换幻灯片主题，
1. 自定义导言区，
1. R Markdown 幻灯片模版。













下面是另一份完整的 R Markdown 模版，内容十分丰富：添加多个作者，动态日期， [交叉引用](https://bookdown.org/yihui/bookdown/cross-references.html)[@Xie2016]，参考文献，文献样式，Verona 主题，自定义导言区 `header-includes`，右下角 Logo，R 绘图设备改为 `"cairo_pdf"`，设置幻灯片主题 Verona 的选项等[^theme-verona]。读者可以注释和编译交替进行，细节就不说了，可以看看后面的参考文献，边看边玩！

[^theme-verona]: 通过查看 Verona 主题 <https://ctan.org/pkg/beamer-verona> 的手册，知道它有一些额外的选项控制幻灯片样式，

```{verbatim}
---
title: "R Markdown 制作 beamer 幻灯片"
author:
  - 黄湘云
  - 李四
institute: "xxx 大学学院"
date: "`r Sys.Date()`"
documentclass: ctexbeamer
output: 
  bookdown::pdf_book: 
    number_sections: yes
    toc: no
    base_format: rmarkdown::beamer_presentation
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: no
    template: null
    dev: "cairo_pdf"
    theme: Verona
header-includes:
  - \logo{\includegraphics[height=0.8cm]{`r file.path(R.home("doc"), "html", "Rlogo")`}}
  - \usepackage{pifont}
  - \usepackage{iitem}
  - \setbeamertemplate{itemize item}{\ding{47}}
  - \setbeamertemplate{itemize subitem}{\ding{46}}
themeoptions: 
  - colorblocks
  - showheader
  - red
biblio-style: apalike
natbiboptions: "authoryear,round"
bibliography: 
  - packages.bib
classoption: "fontset=fandol"
link-citations: yes
section-titles: false
biblio-title: 参考文献
colorlinks: yes
---
```

`bookdown::pdf_book` 下的 `number_sections`、`toc` 等皆是其参数，详情可查看帮助文档 `?bookdown::pdf_book`。上面将 `rmarkdown::beamer_presentation` 作为 `bookdown::pdf_book` 的 `base_format` 而不是像默认的 beamer 模版那样直接引用，是为了获得交叉引用的能力。

结合 Pandoc 内建 LaTeX 模版，你会发现，除了 output 字段下的键值对，其它都在。结合位置来看 `header-includes` 相当于 premble （LaTeX 文档的导言区）。下面摘取设置 beamer 幻灯片的部分 LaTeX 模版内容加以说明。

```latex
$if(beamer)$
$if(theme)$
\usetheme[$for(themeoptions)$$themeoptions$$sep$,$endfor$]{$theme$}
$endif$
$if(colortheme)$
\usecolortheme{$colortheme$}
$endif$
$if(fonttheme)$
\usefonttheme{$fonttheme$}
$endif$
$if(mainfont)$
\usefonttheme{serif} % use mainfont rather than sansfont for slide text
$endif$
$if(innertheme)$
\useinnertheme{$innertheme$}
$endif$
$if(outertheme)$
\useoutertheme{$outertheme$}
$endif$
$endif$
```

beamer 默认的主题提供了一些 block 样式，比如 exampleblock、alertblock、block 等。

````{verbatim}
::: {.exampleblock data-latex="{提示}"}
提示
:::
````

当然，有些主题还有自定义的 block 样式，像引用名人名言

````{verbatim}
::: {.quotation data-latex="[John Gruber]"}
A Markdown-formatted document should be publishable as-is, as plain text, 
without looking like it’s been marked up with tags or formatting instructions.  
:::
````

此处，不一一介绍，详情见[@Alison2021]。完整的 R Markdown 幻灯片模版如下：

````{verbatim}
---
title: "R Markdown 制作 beamer 幻灯片"
author:
  - 张三
  - 李四
institute: "xxx 大学学院"
date: "`r Sys.Date()`"
documentclass: ctexbeamer
output: 
  bookdown::pdf_book: 
    number_sections: yes
    toc: no
    base_format: rmarkdown::beamer_presentation
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: no
    template: null
    dev: "cairo_pdf"
    theme: Verona
header-includes:
  - \logo{\includegraphics[height=0.8cm]{`r file.path(R.home("doc"), "html", "Rlogo")`}}
  - \usepackage{pifont}
  - \usepackage{iitem}
  - \setbeamertemplate{itemize item}{\ding{47}}
  - \setbeamertemplate{itemize subitem}{\ding{46}}
themeoptions: 
  - colorblocks
  - showheader
  - red
biblio-style: apalike
natbiboptions: "authoryear,round"
bibliography: 
  - packages.bib
classoption: "fontset=fandol"
link-citations: yes
section-titles: false
biblio-title: 参考文献
colorlinks: yes
---

## 介绍

::: {.quotation data-latex="[John Gruber]"}
A Markdown-formatted document should be publishable as-is, as plain text, 
without looking like it’s been marked up with tags or formatting instructions.  
:::

Markdown 提供一种简洁的格式语法，
用来编辑 HTML、PDF 和 MS Word 文档，
数学公式还是用 LaTeX 排版的好， 
$\boldsymbol{\Sigma}$ 是希腊字母 $\Sigma$ 的加粗形式，
$\mathcal{A}$ 是普通字母 $A$ 的花体形式。

## 自定义 block

::: {.exampleblock data-latex="{提示}"}
记得安装一些 LaTeX 宏包，如果不记得也没关系，
大多数情况下 tinytex 会找齐依赖安装好，只是初次运行会有点慢！

```r
tinytex::tlmgr_install(c("psnfss", "iitem", "beamer-verona"))
```
:::
````

编译出来的效果如下：

![rmarkdown-verona](https://user-images.githubusercontent.com/12031874/135652566-08f27f9b-c7a0-4bcf-810a-88859e6db6a7.gif)


## R Markdown（忍者篇）{#rmarkdown-ninja}

此外，R 社区有几个 R 包专门打包了一些 R Markdown 幻灯片模版，比如 [binb](https://github.com/eddelbuettel/binb) 和 [uiucthemes](https://github.com/illinois-r/uiucthemes) 包，如何使用便不再赘述，掌握以上介绍的规律，beamer 主题任你玩[^custom-block]。

[^custom-block]: 想来想去，好像只剩一种情况还没有介绍，就是使用 Pandoc 支持的 [Lua 外挂](https://pandoc.org/lua-filters.html)，借助 LaTeX 宏包 [tcolorbox](https://ctan.org/pkg/tcolorbox) [自定义 block](https://bookdown.org/yihui/rmarkdown-cookbook/custom-blocks.html)，而这当属于忍者玩法了！

Christophe Dervieux 

bookdown 提供的特殊语法 `name="bababa"` 仅适用于那些在 beamer （不局限于 beamer 基础文类提供的主题，还包括其它衍生的 beamer 主题，下同）中有定义且被 bookdown 支持的。其它 bookdown 支持的环境只有在 beamer 的导言区先定义才能被使用，如命题 `proposition`，猜想 `conjecture`，练习 `exercise`，假设 `hypothesis`，注记 `remark`，通常这部分东西放在 `preamble.tex` 里，并在 R Markdown 的 YAML 区域引入。另外，还有一些环境只出现在 beamer 文类下，bookdown 对这些是不支持的，比如事实 `fact`，问题 `problem` `block`，示例 `exampleblock` 等。

创建一个 GIF 图，提供 R Markdown 基础 beamer 文类的模版，包含两三种常用环境，其他环境情况列一个表格。

忍者篇介绍萧山主题模版，列出 beamer 中有定义的和 bookdown 支持的。

beamer 文档找到各类定理、block 块
然后如何映射过来


# 技巧陷阱 {#tricks-pitfalls}

## 数学符号 {#math-symbols}

在正式介绍后续的 beamer 主题之前，还要先介绍一点数学符号和数学字体的坑，毕竟，学术型幻灯片很难离开数学公式[@Pakin2021]。在遇到花体数学符号，如常用来表示域或空间的 `$\mathcal{A,S}, \mathscr{A}, \mathbb{A,R}$`，抑或是常见的损失函数符号 `$\mathcal{L}$`。
**unicode-math** 定义的数学样式有点怪，和通常见到的不一样，以前排版毕业论文的时候[坑过我一回](https://d.cosx.org/d/419931)，主要原因是 **unicode-math** 使用 Latin Modern Math 的 OpenType 字体 [@Zeng2020]。

```{verbatim}
---
title: "Untitled"
output: 
  pdf_document: 
    latex_engine: xelatex
    template: null
    extra_dependencies:
      ctex:
       - fontset=fandol
---

拿一些数学符号举个例子，如 `\mathcal{A},\mathscr{A}` 和 `\mathbb{A}`会被依次渲染成

$$
\mathcal{A},\mathscr{A},\mathbb{A}
$$
```


![unicode-math](https://user-images.githubusercontent.com/12031874/135603599-00602d32-c007-4eb1-a8bc-c5a5a17f19f0.png)


Pandoc 内建的 LaTeX 模版默认调用 **unicode-math** 宏包的，除非编译 R Markdown 的时候，启用[LaTeX 变量](https://pandoc.org/MANUAL.html#using-variables-in-templates)`mathspec: yes`，加载 **amsfonts** 和 **mathrsfs** 宏包[@Xie2020]。目前，仅有的数学字体支持的数学符号还不太全，但未来是趋势，为啥？统一性，不需要调其它数学符号包，比如 `\mscrA` 和 `\BbbA` 分别等价于 `\mathscr{A}` 和 `\mathbb{A}`。

````{verbatim}
---
title: "Untitled"
mathspec: yes
output: 
  pdf_document: 
    latex_engine: xelatex
    template: null
    extra_dependencies:
      ctex:
       - fontset=fandol
      amsfonts: null
      mathrsfs: null
---

拿一些数学符号举个例子，如 `\mathcal{A},\mathscr{A}` 
和 `\mathbb{A}`会被依次渲染成

$$
\mathcal{A},\mathscr{A},\mathbb{A}
$$
````

![mathspec](https://user-images.githubusercontent.com/12031874/135605483-1cfe1c86-1567-495e-b3a0-27ff12a72b7f.png)


::: rmdnote
[fandol 字体](https://ctan.org/pkg/fandol)支持的汉字有限，比如[刘思喆](https://bjt.name/)的「喆」字就渲染成了 <img height="20" alt="fandol-font" src="https://user-images.githubusercontent.com/12031874/135615813-cde3464d-21d3-43e1-b951-c247a6215e5b.png">，更别说[许宝騄先生](https://zh.wikipedia.org/wiki/%E8%A8%B1%E5%AF%B6%E9%A8%84)的「騄」字了。
:::

Fira 系列字体配 metropolis 主题是比较常见的，只是 Fira Math 提供的字符集有限，不得不借助 XITS Math 补位（比如矩阵转置的符号），后者支持是最广的。在 **unicode-math** 的世界里，公式环境里，加粗希腊字母，得用 `\symbf` 而不是 `\boldsymbol`。XITS Math、Fira Math 等字体数学符号的支持情况详见[unicode-math 宏包的官方文档](http://mirrors.ctan.org/macros/unicodetex/latex/unicode-math/unimath-symbols.pdf)。

<center>表1：不同的数学字体支持的符号数量不同 </center>

| 数学字体                                                     | 符号数量 |
| :------------------------------------------------------------ | :-------- |
| [Latin Modern Math](https://ctan.org/pkg/lm)                 | 1585     |
| [XITS Math](https://ctan.org/pkg/xits)                       | 2427     |
| [STIX Math Two](https://ctan.org/pkg/stix2-otf)              | 2422     |
| [TeX Gyre Pagella Math](https://ctan.org/pkg/tex-gyre-math-pagella) | 1638     |
| [DejaVu Math TeX Gyre](https://ctan.org/pkg/tex-gyre-math-dejavu) | 1640     |
| [Fira Math](https://ctan.org/pkg/firamath)                   | 1052     |



## 文档汉化 {#chinese-document}

最近统计之都论坛里又有人陆续[踩](https://d.cosx.org/d/422613)到我以前[踩](https://d.cosx.org/d/419931)过的[坑 1](https://d.cosx.org/d/421770)、[坑 2](https://d.cosx.org/d/421834)、[坑 3](https://d.cosx.org/d/422087)、[坑 4](https://d.cosx.org/d/422343)，都是中文 R Markdown 文档相关， 这里不妨简单说一下。

````{verbatim}
---
title: "测试"
author:
  - 黄湘云
documentclass: ctexart
keywords:
  - rmarkdown
  - rticles
  - LaTeX
output:
  rticles::ctex:
    fig_caption: yes
    number_sections: yes
    toc: yes
geometry: 
  - tmargin=1.8cm
  - bmargin=1.8cm
  - lmargin=2.1cm
  - rmargin=2.1cm  
---

# 数学公式 {#math}

$\mathbf{\Sigma}$
````

这位坛友准备在公式环境里用 `\mathbf` 命令加粗希腊字母 `$\Sigma$`，这本身是不行的，它只能用来加粗普通的字母，如 `$A,B,C,a,b,c,X,Y,Z,x,y,z$`。加粗希腊字母，需要 `\boldsymbol` 命令，而 `rticles::ctex` 中文模版，在默认设置下，会使用 Pandoc 内建 LaTeX 模版，调用 XeLaTeX 编译，加载 **unicode-math** 宏包处理数学公式，此时，希腊字母对 `\boldsymbol` 命令免疫，要加粗特效，必须用 **unicode-math** 的专用命令 `\symbf`。

如果准备在文中统一采用 **unicode-math** 处理数学公式，那么，把 `\mathbf` 换成 `\symbf`，问题即告结束。但是，目前排版数学公式比较通用的方式不是 **unicode-math**，还是原来的 amsmath 及其扩展宏包。如何转过去呢？其实，很简单，在 YAML 里添加一行 `mathspec: yes` 即可，Pandoc 的 LaTeX 模版支持原先的方案，此时编译还是会报错，报错的主要信息如下：

```
! LaTeX Error: Option clash for package fontspec.
```

这是因为 ctexart 文类自动加载了 fontspec 宏包，而它与 mathspec 宏包冲突，所以要替换为原始的 article 文类，同时加载 ctex 宏包处理中文字符，这里采用 fandol 中文字体作为演示，所以目前最佳的解决方案如下：

````{verbatim}
---
title: "测试"
author:
  - 无
documentclass: article
mathspec: yes
keywords:
  - 无
output:
  rticles::ctex:
    fig_caption: yes
    number_sections: yes
    toc: yes
    template: null
    extra_dependencies:
      ctex:
       - fontset=fandol
geometry: 
  - tmargin=1.8cm
  - bmargin=1.8cm
  - lmargin=2.1cm
  - rmargin=2.1cm  
---

$\boldsymbol{\Sigma}$ 是希腊字母 $\Sigma$ 的加粗形式，
$\mathcal{A}$ 是普通字母 $A$ 的花体形式。
````

::: rmdtip
RStudio IDE 使用 [MathJaX](https://www.mathjax.org/) 来渲染 R Markdown 文档里的数学公式，MathJaX 不支持的数学符号命令是不能预览的。来自 **unicode-math** 的 `\symbf` 命令是不受支持的，会高亮成红色。那支持的有哪些呢？完整的支持列表见这个[文档](https://docs.mathjax.org/en/latest/input/tex/macros/index.html)，常见的 `\mathbb` 空心体 `$\mathbb{A}$` 和 `\mathfrak` 火星体 `$\mathfrak{A}$` 来自宏包 amsfonts，`\mathscr` 花体 `$\mathscr{A}$` 和 `\bm` 粗体 `$\bm{A}$` 命令分别来自 mathrsfs 和 bm。amsmath 相关的大都支持，较为精细地调整数学公式可以去看[amsmath 文档](https://www.latex-project.org/help/documentation/amsldoc.pdf)，此处仅摘抄一例 `$\sqrt{x} +\sqrt{y} + \sqrt{z}$` 和 `$\sqrt{x} +\sqrt{\smash[b]{y}} + \sqrt{z}$`，能看出来差别的一定有一双火眼金睛！

![rstudio-mathjax](https://user-images.githubusercontent.com/12031874/140643778-c3527a55-1455-48c2-ac72-a43474f74e55.png)
:::

再次强行回到本文主题，上述巨坑在 article 普通文类下介绍，而不是在 beamer 幻灯片主题下介绍也是有重要原因的：其一，我见过的大部分坑的背景都是 article 文类。其二，这个坑并不会随文类切换到 beamer 而有所不同！其三，若大家再遇到类似坑不妨也切换到 article 文类，这个是最基础的，褪去尽可能多的外部依赖，方便去根因。



# 本文小结 {#summary}



# 参考文献 {#refer}

<div id="refs"></div>


# 环境信息 {#session}

在 RStudio IDE 内编辑本文的 Rmarkdown 源文件，用 **blogdown** [@Xie2017]构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 knitr 之后的 Markdown 文件，得益于 **blogdown** 对 Rmarkdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息，供读者复现参考。

```{r}
xfun::session_info(c(
  "tinytex", "knitr", "rmarkdown", "bookdown", "blogdown"
), dependencies = FALSE)
```


# 附录 {#appendix}

本文写作过程中遇到一些有用的小工具，比如将 PDF 文档转为 PNG 图片或 GIF 动图。


## PDF 文档转 GIF 动图

将 PDF 格式的多页幻灯片转为 GIF 动图可以借助 [ImageMagick](https://imagemagick.org) 一行命令搞定：

```bash
convert -delay 250 -density 300x300 -geometry 960x720 beamer.pdf beamer.gif
```

值得注意的是在 Ubuntu 20.04 LTS 系统环境下，安装完 ImageMagick 还需执行如下命令：

```bash
sudo sed -i_bak \
's/rights="none" pattern="PDF"/rights="read | write" pattern="PDF"/' \
/etc/ImageMagick-6/policy.xml
```

此外，还可以安装 [**magick**](https://github.com/ropensci/magick) 包，用 R 代码实现转化过程：

```r
library(magick)
img = image_read_pdf("beamer.pdf", density = 300)
img %>% 
  image_resize(geometry_size_pixels(960, 720)) %>% 
  image_animate(delay = 250) %>% 
  image_write("beamer.gif")
```

## PDF 文档转 PNG 图片

与上面是类似的，一行命令如下：

```bash
convert -density 300x300 -geometry 960x720 beamer.pdf beamer.png
```


## 中文 R Markdown 模版




## 英文 R Markdown 模版




